<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Text-to-Speech Streaming</title>
</head>
<body>
    <textarea id="textInput" placeholder="Enter text">hello world how are you doing today? I am your personal assistant</textarea><br>
    <select id="voiceSelect"></select><br>
    <button id="playButton">Play</button>

    <script>
        const playButton = document.getElementById('playButton');
        const textInput = document.getElementById('textInput');
        const voiceSelect = document.getElementById('voiceSelect');

        // Populate voice options
        fetch('http://localhost/voices')
            .then(response => response.json())
            .then(voices => {
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice;
                    option.textContent = voice;
                    voiceSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching available voices:', error);
            });

        playButton.addEventListener('click', async () => {
            const text = textInput.value;
            const voice = voiceSelect.value;

            try {
                const response = await fetch('http://localhost/tts-stream-real-time', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text, voice })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                // Create audio context
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Continuously read and play audio chunks
                const reader = response.body.getReader();
                const textDecoder = new TextDecoder();

                let partialChunk = '';
                let audioBuffer = null;

                function processAudioChunk({ done, value }) {
                    if (done) {
                        console.log('Audio streaming complete');
                        return;
                    }

                    const chunkData = textDecoder.decode(value);
                    const chunkNumbers = chunkData.trim().split(',').map(Number);

                    // Concatenate the new chunk with the previous partial chunk
                    const concatenatedData = partialChunk + chunkData;
                    
                    // Split the concatenated data into individual audio samples
                    const samples = concatenatedData.split(',').map(Number);

                    // Store the last number as the new partial chunk
                    partialChunk = samples.pop().toString();

                    // Create a new Float32Array to hold the audio samples
                    const audioData = new Float32Array(samples.length);
                    for (let i = 0; i < samples.length; i++) {
                        audioData[i] = samples[i] / 32768; // Convert from int16 to float32
                    }

                    // Create a new audio buffer if it's null or if the length has changed
                    if (!audioBuffer || audioBuffer.length !== audioData.length) {
                        audioBuffer = audioContext.createBuffer(1, audioData.length, audioContext.sampleRate);
                    }

                    // Copy the audio data to the buffer
                    audioBuffer.copyToChannel(audioData, 0);

                    // Create a new buffer source node
                    const source = audioContext.createBufferSource();
                    source.buffer = audioBuffer;

                    // Connect the source to the destination and start playing
                    source.connect(audioContext.destination);
                    source.start();

                    // Continue reading next chunk
                    reader.read().then(processAudioChunk).catch(error => {
                        console.error('Error reading audio stream:', error);
                    });
                }

                // Start reading and playing audio chunks
                reader.read().then(processAudioChunk).catch(error => {
                    console.error('Error reading audio stream:', error);
                });
            } catch (error) {
                console.error('Error playing audio:', error);
            }
        });
    </script>
</body>
</html>
